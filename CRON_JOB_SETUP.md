# Настройка Cron Job для Netlify - Подробное Руководство

## Задача
Настроить автоматический запуск `/api/push/check` каждый день в 8:00 утра для проверки и отправки push-уведомлений студентам.

## Варианты Решения

### Вариант 1: Netlify Scheduled Functions ⭐ (Рекомендуется)

#### Преимущества
- ✅ Все в одном месте (не нужен внешний сервис)
- ✅ Бесплатно и надежно
- ✅ Легко управлять через код
- ✅ Автоматический деплой при изменении кода

#### Лимиты Бесплатного Плана
- **Запросы**: 125,000 запросов/месяц на все функции
- **Время выполнения**: 10 секунд максимум на функцию
- **Количество**: Неограниченное количество scheduled functions
- **Минимальный интервал**: 1 час (нельзя запускать чаще)
- **Точность**: ±5 минут (может запуститься не ровно в 8:00, а в 8:03-8:05)

#### Расчет Использования
- 1 запуск в день × 30 дней = **30 запросов/месяц**
- Это **0.024%** от лимита (очень мало)

#### Недостатки
- ⚠️ Точность ±5 минут (не критично для нашего случая)
- ⚠️ Минимальный интервал 1 час (нам подходит)

#### Как Настроить

**Шаг 1: Создать файл функции**

Создайте файл `netlify/functions/scheduled-push-check.mjs`:

```javascript
import { schedule } from '@netlify/functions';

export const handler = schedule('0 8 * * *', async () => {
  try {
    const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://your-site.netlify.app';
    const response = await fetch(`${siteUrl}/api/push/check`, {
      method: 'GET',
      headers: {
        'User-Agent': 'Netlify-Scheduled-Function',
      },
    });
    
    const result = await response.text();
    console.log('Push check completed:', response.status, result);
    
    return {
      statusCode: 200,
      body: JSON.stringify({
        message: 'Push check completed',
        status: response.status,
      }),
    };
  } catch (error) {
    console.error('Push check failed:', error);
    return {
      statusCode: 500,
      body: JSON.stringify({
        message: 'Push check failed',
        error: error.message,
      }),
    };
  }
});
```

**Шаг 2: Установить зависимость**

```bash
npm install --save-dev @netlify/functions
```

**Шаг 3: Закоммитить и запушить**

```bash
git add netlify/functions/scheduled-push-check.mjs package.json
git commit -m "Add Netlify scheduled function for daily push check"
git push
```

**Шаг 4: Проверить в Dashboard**

1. Откройте Netlify Dashboard
2. Перейдите в **Functions**
3. Найдите `scheduled-push-check`
4. Проверьте логи после первого запуска

#### Формат Cron
- `0 8 * * *` - каждый день в 8:00 UTC
- Если нужно другое время, используйте [crontab.guru](https://crontab.guru) для генерации

---

### Вариант 2: cron-job.org (Внешний Сервис)

#### Преимущества
- ✅ Высокая точность (±30 секунд)
- ✅ Минимальный интервал: 1 минута
- ✅ Простая настройка через UI
- ✅ Email-уведомления при ошибках

#### Лимиты Бесплатного Плана
- **Количество jobs**: 3 cron jobs бесплатно
- **Минимальный интервал**: 1 минута
- **Точность**: Высокая (обычно ±30 секунд)
- **Timeout**: 30 секунд на запрос
- **История**: Последние 10 запусков

#### Недостатки
- ⚠️ Зависимость от внешнего сервиса
- ⚠️ Только 3 бесплатных jobs
- ⚠️ Нужна отдельная регистрация

#### Как Настроить

**Шаг 1: Регистрация**
1. Перейдите на [cron-job.org](https://cron-job.org)
2. Создайте бесплатный аккаунт

**Шаг 2: Создание Cron Job**
1. Нажмите **Create cronjob**
2. Заполните форму:
   - **Title**: `RGSU Push Check`
   - **URL**: `https://ваш-сайт.netlify.app/api/push/check`
   - **Schedule**: Выберите **Every day at 8:00 AM**
   - **Timezone**: Выберите ваш часовой пояс (например, Europe/Minsk)
3. Нажмите **Create**

**Шаг 3: Настройка Уведомлений (Опционально)**
1. В настройках job включите **Email notifications on failure**
2. Укажите ваш email

**Шаг 4: Тестирование**
1. Нажмите **Run now** для тестового запуска
2. Проверьте статус и логи

---

### Вариант 3: GitHub Actions (Альтернатива)

#### Преимущества
- ✅ Бесплатно для публичных репозиториев
- ✅ Интеграция с GitHub
- ✅ Гибкая настройка

#### Лимиты
- **Минуты**: 2,000 минут/месяц для приватных репозиториев
- **Публичные репозитории**: Неограниченно
- **Точность**: ±15 минут

#### Недостатки
- ⚠️ Низкая точность (±15 минут)
- ⚠️ Может не запуститься, если репозиторий неактивен

#### Как Настроить

Создайте файл `.github/workflows/scheduled-push-check.yml`:

```yaml
name: Scheduled Push Check

on:
  schedule:
    - cron: '0 8 * * *'  # Каждый день в 8:00 UTC
  workflow_dispatch:  # Позволяет запускать вручную

jobs:
  push-check:
    runs-on: ubuntu-latest
    steps:
      - name: Call Push Check API
        run: |
          curl -X GET https://ваш-сайт.netlify.app/api/push/check
```

---

## Сравнительная Таблица

| Критерий | Netlify Functions | cron-job.org | GitHub Actions |
|----------|-------------------|--------------|----------------|
| **Стоимость** | Бесплатно | Бесплатно (3 jobs) | Бесплатно |
| **Точность** | ±5 минут | ±30 секунд | ±15 минут |
| **Мин. интервал** | 1 час | 1 минута | 5 минут |
| **Настройка** | Код | UI | Код |
| **Зависимость** | Нет | Внешний сервис | GitHub |
| **Логи** | Netlify Dashboard | cron-job.org | GitHub Actions |
| **Уведомления** | Нет | Email | GitHub |

---

## Рекомендация

**Для вашего случая рекомендую Netlify Scheduled Functions (Вариант 1):**

1. **Простота**: Все в одном месте, не нужны внешние сервисы
2. **Надежность**: Работает на той же инфраструктуре, что и сайт
3. **Достаточная точность**: ±5 минут для проверки push-уведомлений не критично
4. **Бесплатно**: 30 запросов/месяц - это 0.024% от лимита

**Когда использовать cron-job.org:**
- Если нужна высокая точность (±30 секунд)
- Если нужно запускать чаще, чем раз в час
- Если хотите email-уведомления при ошибках

---

## Следующие Шаги

1. [ ] Выбрать вариант (рекомендуется Netlify Functions)
2. [ ] Создать файл функции или настроить внешний сервис
3. [ ] Протестировать запуск
4. [ ] Проверить логи
5. [ ] Настроить мониторинг (опционально)

---

## Мониторинг и Отладка

### Netlify Functions
- **Логи**: Netlify Dashboard → Functions → scheduled-push-check → Logs
- **Тестирование**: Нельзя запустить вручную, только по расписанию

### cron-job.org
- **Логи**: Dashboard → Job → Execution history
- **Тестирование**: Кнопка "Run now"

### Проверка работы API
Можно вручную вызвать API для проверки:
```bash
curl https://ваш-сайт.netlify.app/api/push/check
```

---

**Дата создания**: 2026-02-04  
**Статус**: Готово к выбору и реализации
